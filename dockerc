#!/bin/sh

# DockerC (v1.2.2)
# Wrapper for docker compose commands in your project.
# https://github.com/matiboux/dockerc
# MIT License
# Copyright (c) 2023 Matiboux

# Default options
QUIET=false

# Parse options
while true; do
	case "$1" in
		--help)
			# Print help and exit
			echo "Usage: $0 [options] [context] [...args]"
			echo "  context syntax: [first] | [first]-[second]"
			echo "  options:"
			echo "    --help: Print this help"
			echo "    -q: Quiet, do not print docker compose command"
			exit 0
			;;
		-q)
			# Quiet, do not print docker compose command
			QUIET=true
			shift
			;;
		*)
			break
			;;
	esac
done

if [ $# -gt 0 ]; then
	# Get context from first parameter and shift
	CONTEXT="$1"
	shift
else
	CONTEXT=""
fi

# Other parameters are arguments passed to docker compose
ARGS="$@"
if [ -z "$ARGS" ]; then
	# If arguments are empty, set to the default arguments
	ARGS="up -d"
fi

COMPOSE_FILE_ARGS=""

# If context is --, ignore context and use docker compose without file arguments
NO_COMPOSE_FILE_ARGS=false
if [ "$CONTEXT" = "--" ]; then
	NO_COMPOSE_FILE_ARGS=true
fi

if [ "$NO_COMPOSE_FILE_ARGS" = false ]; then

	# Split context into first and second parts
	IFS="-" read -r first second <<EOF
$CONTEXT
EOF

	# If first part is empty and second part is not empty,
	# Set first part to second part and second part to empty
	if [ -z "$first" ] && [ ! -z "$second" ]; then
		first="-$second"
		second=""
	fi

	# Check in current directory, then in docker directory
	while read -r dir; do

		if [ ! -z "$first" ]; then

			# Set compose file arguments
			if [ -f "$dir/docker-compose-$first.yml" ]; then

				if [ -z "$second" ]; then
					COMPOSE_FILE_ARGS=" -f $dir/docker-compose-$first.yml"

				elif [ -f "$dir/docker-compose-$first.$second.yml" ]; then
					COMPOSE_FILE_ARGS=" -f $dir/docker-compose-$first.yml -f $dir/docker-compose-$first.$second.yml"
				fi

			elif [ -f "$dir/docker-compose.yml" ]; then

				if [ -f "$dir/docker-compose.$first.yml" ]; then
					COMPOSE_FILE_ARGS=" -f $dir/docker-compose.yml -f $dir/docker-compose.$first.yml"

				elif [ "$first" = "prod" ]; then
					COMPOSE_FILE_ARGS=" -f $dir/docker-compose.yml"
				fi
			fi

		fi

		if [ ! -z "$COMPOSE_FILE_ARGS" ]; then
			# Break loop if compose file arguments are set!
			break

		elif [ -f "$dir/docker-compose.yml" ] && \
		   ([ -z "$first" ] || [ "$first" = "dev" ]);
		then

			if [ -f "$dir/docker-compose.override.yml" ]; then
				COMPOSE_FILE_ARGS=" -f $dir/docker-compose.yml -f $dir/docker-compose.override.yml"

			else
				COMPOSE_FILE_ARGS=" -f $dir/docker-compose.yml"
			fi

			# Break loop because compose file arguments are set!
			break

		fi

	done <<EOF
.
./docker
EOF

	# If compose file arguments are empty, exit with error
	if [ -z "$COMPOSE_FILE_ARGS" ]; then
		if [ -z "$second" ]; then
			echo "Error: Unknown context '$first'"
		else
			echo "Error: Unknown context '$first-$second'"
		fi
		exit 1
	fi

fi

if [ "$QUIET" = false ]; then
	# Print docker compose command
	echo ""
	echo "> docker compose$COMPOSE_FILE_ARGS $ARGS"
	echo ""
fi

# Run docker compose
exec docker compose$COMPOSE_FILE_ARGS $ARGS
